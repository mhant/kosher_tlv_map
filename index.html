<!DOCTYPE html>
<html>

  <head>
    <script>
      window.fbAsyncInit = function() {
        FB.init({
          appId: '621107394906919',
          xfbml: true,
          version: 'v2.10'
        });

        FB.AppEvents.logPageView();
      };
      (function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) {
          return;
        }
        js = d.createElement(s);
        js.id = id;
        js.src = "https://connect.facebook.net/en_US/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
      }(document, 'script', 'facebook-jssdk'));
    </script>
    <script
      src="https://code.jquery.com/jquery-3.3.1.min.js"
      integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
      crossorigin="anonymous"
    ></script>
      <!-- Latest compiled and minified CSS -->
      <link
        rel="stylesheet"
        href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"

        integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"

        crossorigin="anonymous"
      >

        <!-- Optional theme -->
        <link
          rel="stylesheet"
          href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css"

          integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp"

          crossorigin="anonymous"
        >

          <!-- Latest compiled and minified JavaScript -->
          <script
            src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"

            integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"

            crossorigin="anonymous"
          ></script>
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
            <meta
              name="viewport"
              content="initial-scale=1"
            >
              <title>Kosher TLV Map</title>
              <link
                rel="shortcut icon"
                href="assets/favicon.ico"
                type="image/x-icon"
              >
                <link
                  rel="icon"
                  href="assets/favicon.ico"
                  type="image/x-icon"
                >
                  <link
                    rel="stylesheet"
                    href="style.css"
                  >
  </head>

  <body>
    <script
      src="corrected_addresses_bool.js"
      charset="utf-8"
    ></script>
    <script
      src="temp_addresses_to_hide.js"
      charset="utf-8"
    ></script>      <script
        src="cdn_path_file.js"
        charset="utf-8"
      ></script>
        <div
          class="wrapper"
          id="wrapper"
        >
          <!-- Sidebar -->
          <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
              <li class="sidebar-brand">
                <a
                  href="#"
                  id="sidebar-title"
                  align="right"
                >
                  Close X&nbsp&nbsp
                  </a>
              </li>
              <li>
                Kosher Type:
                <select
                  id="kosher_type_select"
                  onchange="init(this.value);"
                >
                  <option value="0">all</option>
                  <option value="בשרי">בשרי meaty</option>
                  <option value="חלבי">חלבי dairy</option>
                  <option value="פרוה">פרוה parve</option>
                  </select>
              </li>
              <li>
                <input
                  type="checkbox"
                  name="mehadrin_only_check"
                  id="mehadrin_only_check"
                  value="true"
                  onchange="init(kosher_type_select.value);"
                > Mehadrin only/מהדרין בלבד<br>
              </li>
              <li>
                <img src="https://raw.githubusercontent.com/mhant/kosher_tlv_map/master/assets/icon_red.png"
                /> meaty/בשרי
              </li>
              <li>
                <img src="https://raw.githubusercontent.com/mhant/kosher_tlv_map/master/assets/icon_blue.png"
                /> milky/חלבי
              </li>
              <li>
                <img src="https://raw.githubusercontent.com/mhant/kosher_tlv_map/master/assets/icon_green.png"
                /> parve/פרוה
              </li>
              <li>
                <img src="https://maps.google.com/mapfiles/ms/icons/pink.png" />                hotel/מלון
              </li>
              <li>
                <img src="https://maps.google.com/mapfiles/ms/icons/yellow.png" />                other (butcher/grocer/etc)
              </li>
              <li>
                <div style="padding-left:10px;padding-right:20px;margin-top:10px;margin-bottom:5px;">
                  <button
                    class="btn btn-primary"
                    style="width:90%;"
                    id="btn_orig_data"
                  >
                    Original data: Rabanut
                    </button>
                </div>
              </li>
              <li>
                <div style="padding-left:10px;padding-right:20px;margin-top:10px;margin-bottom:5px;">
                  <button
                    class="btn btn-primary"
                    style="width:90%;"
                    id="btn_feedback"
                  >Send feedback/corrections</button>
                </div>
              </li>
              <li>
                <li>
                  <div style="padding-left:10px;padding-right:20px;margin-top:10px;margin-bottom:5px;">
                    <button
                      class="btn btn-primary"
                      data-toggle="modal"
                      data-target="#myModal"
                      style="width:90%;"
                      id="btn_data_modif"
                    >
                      See our data modifications
                      </button>
                  </div>
                </li>
              </li>
              <li>
                <span>A Michael, Ed, and Tali Production</span>
              </li>
            </ul>
          </div>
          <div class="alert alert-warning alert-dismissible" id="disclaimer" hidden>
            <button
              href="#"
              class="close"
              data-dismiss="alert"
              aria-label="close"
              onclick="neverShowAgain()"
            >&times;</button>
              <strong>Disclaimer!</strong> <p><b>Please always make sure to check each restaurant's teudah</b>.
              This data is taken directly from the rabanut website, so it may not be completely up to date.</p>
          </div>
          <div class="header">
            <h1>Kosher TLV Map</h1> Places with a Teudat Kashrut from the Tel Aviv Rabanut <br />
            <a
              href="#menu-toggle"
              class="glyphicon glyphicon-menu-hamburger"
              style="margin-right:5px;"
              id="menu-toggle"
            ></a>
            <button
              id="center_button"
              onclick="recenter()"
              class="glyphicon glyphicon-map-marker"
              style="margin-right:5px;"
            >
              </button>
              <input
                id="search_input"
                class="controls"
                type="text"
                placeholder="Google search in area"
              >
          </div>
          <div class="content">

            <div id="googleMap">  </div>
          </div>
          </div>
          <!-- Modal -->
          <div
            class="modal fade"
            id="myModal"
            tabindex="-1"
            role="dialog"
            aria-labelledby="myModalLabel"
            aria-hidden="true"
          >
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <button
                    type="button"
                    class="close"
                    data-dismiss="modal"
                    aria-hidden="true"
                  >&times;</button>
                    <h4
                      class="modal-title"
                      id="myModalLabel"
                    >Data Corrections</h4>
                </div>
                <div class="modal-body">
                  <iframe
                    id="popup"
                    width="100%"
                    height="380px"
                    frameborder="0"
                    allowtransparency="true"
                  ></iframe>
                </div>
                <div class="modal-footer">
                  <button
                    type="button"
                    class="btn btn-default"
                    data-dismiss="modal"
                  >Close</button>
                </div></div></div></div>
                <script>
                  var map;
                  var markers = [];
                  var me_marker = null;
                  var last_open_infowindow = null ;
                  var show_disc = null ;

                  function neverShowAgain(){
                    localStorage.setItem("showDisclaimer","no");
                      $("#disclaimer").hide();
                  }

                  function recenter() {
                    if (navigator && navigator.geolocation) {
                      navigator.geolocation.getCurrentPosition(function(
                        position) {
                        var pos = {
                          lat: position.coords.latitude,
                          lng: position.coords.longitude
                        };
                        map.setCenter(pos);
                        map.setZoom(17);
                        //map.setIcon("http://maps.google.com/mapfiles/ms/icons/yellow.png") ;

                        if (me_marker != null) { //move existing me marker
                          me_marker.setPosition(pos);
                        } else {
                          me_marker = new google.maps.Marker({
                            map: map,
                            position: pos,
                            icon:  new google.maps.MarkerImage('https://maps.gstatic.com/mapfiles/mobile/mobileimgs2.png', new google.maps.Size(22, 22), new google.maps.Point(0, 18), new google.maps.Point(11, 11)),
                          });
                        }
                      }, function(error, response) {
                        alert(error.message);
                      });
                    } else {
                      // Browser doesn't support Geolocation
                      alert("no geolocation");
                    }
                  }

                  function attachSecretMessage(marker, secretMessage) {
                    var infowindow = new google.maps.InfoWindow({
                      content: secretMessage
                    });
                    marker.addListener('click', function() {
                      if ( show_disc == null ) {
                          // check if have shown disclaimer
                        show_disc = localStorage.getItem("showDisclaimer");
                        if (show_disc === null){
                          show_disc = "yes";
                          localStorage.setItem("showDisclaimer","yes");
                        }
                        if (show_disc === "no"){
                          $("#disclaimer").hide();
                        }
                        else{
                          $("#disclaimer").show();
                        }
                      }


                      if ( last_open_infowindow != null )
                        last_open_infowindow.close();
                      infowindow.open(marker.get('map'), marker);
                      last_open_infowindow = infowindow ;
                    });
                  }

                  function clearMarkers() {
                    for (var i = 0; i < markers.length; i++) {
                      markers[i].setMap(null);
                    }
                    markers = [];
                  }

                  function filterAddress(address, filter_type) {
                    //filters and returns true for any place we don't want to display.
                    //also sets the icon url on the ones we want to keep.
                    var iconURL;
                    var display = true;
                    var typesToIgnore = ['בית ספר לבישול', 'בתי אבות',
                      'בתי חולים', 'מפעל', 'אולמות אירועים'
                    ];
                    var mehadrin = false;
                    if (filter_type == "0") {
                      filter_type = null;
                    }

                    //check to see if this was in the temporary hide list
                   for (var i = 0; i < addresses_to_hide.length; i++) {
                      if (addresses_to_hide[i].rest_name.match(address.rest_name) && addresses_to_hide[i].rest_addr.match(address.rest_addr)) {
                        display = false;
                        return {
                      iconURL: iconURL,
                      display: display
                      };
                      }
                   }
                    //first test for rest type.
                    //do we want to completely ignore it?
                    for (var i = 0; i < typesToIgnore.length; i++) {
                      if (typesToIgnore[i].match(address.rest_type)) {
                        display = false;
                      }
                      if (filter_type && !address.kosher_type.includes(
                          filter_type)) {
                        display = false;
                      }
                    }

                    if (display) {
                      var kosher_type_array = address.kosher_type.split(",");
                      for (var i = 0; i < kosher_type_array.length; i++)
                        if (kosher_type_array[i].match('מהדרין')) {
                          mehadrin = true;
                        }
                      if (mehadrin != true && document.getElementById(
                          'mehadrin_only_check').checked) {
                        display = false; //only want mehadrin
                      }
                    }
                    if (display) {
                      if (address.rest_type.includes('מסעדות') ||
                          address.rest_type.includes('קונדטוריות') ||
                          address.rest_type.includes('קונדיטוריות') ||
                          address.rest_type === 'מהדרין' ||
                          address.rest_type === 'רגיל') {
                        var colour = "";
                        if (address.kosher_type.includes('חלבי')) {
                          colour += 'blue';
                        }
                        if (address.kosher_type.includes('בשרי')) {
                          colour += 'red';
                        }
                        if (address.kosher_type.includes('פרוה')) {
                          colour += 'green';
                        }
                        iconURL = cdn_path + colour + '.png';

                      } else if (address.rest_type == 'בתי מלון') {
                        iconURL =
                          'https://maps.google.com/mapfiles/ms/icons/pink' +
                          '.png';

                      } else { //other things like hotels and supermarkets, fruit/veg shops, butchers and fishmongers
                        iconURL =
                          'https://maps.google.com/mapfiles/ms/icons/yellow' +
                          '.png';
                      }

                    }
                    return {
                      iconURL: iconURL,
                      display: display
                    };
                  }

                  function learnMoreClick(name, rest_lat, rest_lng) {
                    var url = "http://maps.google.com/?q=" + name + "&ll=" +
                      rest_lat + "," + rest_lng;
                    var params = {};
                    params[FB.AppEvents.ParameterNames.CONTENT_TYPE] =
                      "learnMore";
                    params[FB.AppEvents.ParameterNames.CONTENT_ID] = name + rest_lat +
                      ":" + rest_lng;
                    FB.AppEvents.logEvent(FB.AppEvents.EventNames.VIEWED_CONTENT,
                      0, params);
                    window.open(url, '_blank');
                  }

                  function init(filter_type) {
                    //if first init, otherwise check filter_type
                    if (!filter_type) {
                      var myStyles =[{
                            featureType: "poi",
                            elementType: "labels",
                            stylers: [
                                  { visibility: "on" },
                                  {saturation: '-100'},
                                  //{lightness:'50' },
                            ]
                        }];
                      var latlng = new google.maps.LatLng(32.071936, 34.777017);
                      var mapOptions = {
                        zoom: 14,
                        center: latlng,
                        mapTypeId: google.maps.MapTypeId.ROADMAP,
                        mapTypeControl: false,
                        //use either clickableIcons: false, or the styles: myStyles
                        clickableIcons: false,
                        styles: myStyles,
                      }
                      map = new google.maps.Map(document.getElementById(
                        'googleMap'), mapOptions);
                    } else {
                      clearMarkers();
                    }
                    for (var i = 0; i < addresses.length; i++) { //now starting from element 1, since 0 is the column titles.
                      var rest = addresses[i];
                      filterResult = filterAddress(rest, filter_type);
                      if (!filterResult.display)
                        continue; //skip this place.
                      var address = rest.rest_addr;
                      var name = rest.rest_name;
                      var type = rest.rest_type;
                      var kosher_type = rest.kosher_type;
                      var expire = rest.kosher_exp;
                      var rest_lat = parseFloat(addresses[i].lat);
                      var rest_lng = parseFloat(addresses[i].lng);
                      var location = {
                        lat: rest_lat,
                        lng: rest_lng
                      };
                      var learn_more_link =
                        '<br /><button onClick="learnMoreClick(\'' +
                        encodeURIComponent(name) + '\',\'' + rest_lat + '\',\'' +
                        rest_lng + '\')">google it</button>';
                      if (name === null) {
                        name = '';
                      }
                      var marker = new google.maps.Marker({
                        map: map,
                        position: location,
                        title: name,
                        icon: filterResult.iconURL,
                      });
                      markers.push(marker);
                      attachSecretMessage(marker, "<br /><b>" + name +
                        "</b><br />place type: " + type + "<br />type: " +
                        kosher_type + "<br />" + address + learn_more_link);
                    }
                  }
                  function logButtonClick(type){
                    var params = {};
                    params[FB.AppEvents.ParameterNames.CONTENT_TYPE] =
                      "buttonClick";
                    params[FB.AppEvents.ParameterNames.CONTENT] = type;
                    FB.AppEvents.logEvent(FB.AppEvents.EventNames.VIEWED_CONTENT,
                      0, params);
                  }
                  $(function() {
                    $('#center_button').on('click touchstart', function(e) {
                      recenter();
                    })
                  });
                  //set some on click fucntions yo
                  $('#btn_data_modif').click(function(e) {
                    logButtonClick("corrections_list");
                    $("#myModalLabel").html("Data Corrections");
                    $("#popup").attr('src', 'corrections_list.html');
                  });
                  $('#btn_feedback').click(function(e) {
                    logButtonClick("mailto");
                    $(
                      '<a href="mailto:KosherTLVMap@gmail.com?subject=KosherTLVMap%20Feedback" target="blank"></a>'
                    )[0].click();
                  });
                  $('#btn_orig_data').click(function(e) {
                    logButtonClick("original_list");
                    $(
                      '<a href="http://www.rabanut.co.il/Sapakim/show/comp/comps.aspx" target="blank"></a>'
                    )[0].click();
                  });
                  $("#menu-toggle").click(function(e) {
                    e.preventDefault();
                    $("#wrapper").toggleClass("toggled");
                  });
                  $("#sidebar-title").click(function(e) {
                    e.preventDefault();
                    $("#wrapper").toggleClass("toggled");
                  });
                 $( document ).ready(function() {
                                       initAutocomplete();
                });
                function initAutocomplete() {

                   // Create the search box and link it to the UI element.
                   var input = document.getElementById('search_input');
                   var searchBox = new google.maps.places.SearchBox(input);

                   // Bias the SearchBox results towards current map's viewport.
                   map.addListener('bounds_changed', function() {
                     searchBox.setBounds(map.getBounds());
                   });

                   // Listen for the event fired when the user selects a prediction and retrieve
                   // more details for that place.
                   searchBox.addListener('places_changed', function() {
                     var places = searchBox.getPlaces();
                     // Clear text after selected
                     input.value = '';
                     if (places.length == 0) {
                       return;
                     }
                     //if single place zoom in on it
                     if ( places.length == 1 &&
                       ( places[0].types.includes("restaurant") ||
                          places[0].types.includes("food")
                       )){
                         map.setZoom(19);
                         map.panTo(places[0].geometry.location);
                         return;
                     }
                     // For each place, get the icon, name and location.
                     var bounds = new google.maps.LatLngBounds();
                     places.forEach(function(place) {
                       if (!place.geometry) {
                         console.log("Returned place contains no geometry");
                         return;
                       }


                       if (place.geometry.viewport) {
                         // Only geocodes have viewport.
                         bounds.union(place.geometry.viewport);
                       } else {
                         bounds.extend(place.geometry.location);
                       }
                     });
                     map.fitBounds(bounds);
                   });
                 }
                </script>
                <script src="https://maps.googleapis.com/maps/api/js?libraries=places&key=AIzaSyC5tNymZyzV2DMLnRwYJFJkkGNkCCdTxDI&callback=init">
                </script>
  </body>
</html>
